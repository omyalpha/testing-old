<!DOCTYPE html>
<html lang="en" view-mode="rtl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Affan - PWA Mobile HTML Template">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#0134d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <!-- Title -->
    <title>Roving Care</title>
    <!-- Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet"> 
	<!-- Favicon -->
    <link rel="icon" href="img/favicon.png">
    <link rel="apple-touch-icon" href="img/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="152x152" href="img/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="img/icons/icon-167x167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/icons/icon-180x180.png">
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/bootstrap-icons.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/ion.rangeSlider.min.css">
    <link rel="stylesheet" href="css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="css/apexcharts.css">
    <!-- Core Stylesheet -->
    <link rel="stylesheet" href="stylear.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
	<style>
	.infinite {
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.infitem {
		width: 2em;
	}
	</style>
  </head>
  <body>
    <!-- Preloader -->
    <div class="preloader d-flex align-items-center justify-content-center" id="preloader">
      <div class="spinner-grow text-primary" role="status">
        <div class="sr-only">Loading...</div>
      </div>
    </div>
    <!-- Internet Connection Status -->
    <!-- # This code for showing internet connection status -->
    <div class="internet-connection-status" id="internetStatus"></div>
    <!-- Header Area -->
    <div class="header-area" id="headerArea">
      <div class="container">
        <!-- Header Content -->
        <div class="header-content position-relative d-flex align-items-center justify-content-between">
          <!-- Chat User Info -->
          <div class="chat-user--info d-flex align-items-center">
            <!-- Back Button -->
            <div class="back-button"><a href="#" id="backbtn">
                <svg class="bi bi-arrow-left-short" width="32" height="32" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"></path>
                </svg></a></div>
            <!-- User Thumbnail & Name -->
            <div class="user-thumbnail-name">
              <div class="info ms-1">
                <p class="requestinfo"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="page-content-wrapper py-3 chat-wrapper">
      <div class="container">
        <div class="chat-content-wrap chatdiv">
        </div>
		<div class="alert custom-alert-2 alert-danger alert-dismissible fade show failed" role="alert" style="display:none">
              <button class="btn btn-close btn-close-white position-relative p-1 ms-auto" type="button" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
    </div>
    <div class="chat-footer">
      <div class="container h-100">
        <div class="chat-footer-content h-100 d-flex align-items-center">
          <form action="#">
            <!-- Message -->
            <input class="form-control" id="textmessage" type="text" placeholder="اكتب رسالتك هنا...">
            <!-- Add File -->
            <div class="dropup me-2 uploadfile">
              <button class="btn btn-add-file" type="button" aria-expanded="false">
                <svg class="bi bi-plus-circle" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"></path>
                </svg>
              </button>
            </div>
			<form>
                <input id="newfile" class="form-control" type="file" style="display:none">
              </form>
            <!-- Send -->
            <button class="btn btn-submit" type="submit">
              <svg class="bi bi-cursor" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                <path d="M14.082 2.182a.5.5 0 0 1 .103.557L8.528 15.467a.5.5 0 0 1-.917-.007L5.57 10.694.803 8.652a.5.5 0 0 1-.006-.916l12.728-5.657a.5.5 0 0 1 .556.103zM2.25 8.184l3.897 1.67a.5.5 0 0 1 .262.263l1.67 3.897L12.743 3.52 2.25 8.184z"></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
    <!-- All JavaScript Files -->
	<script src="cordova.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/internet-status.js"></script>
    <script src="js/waypoints.min.js"></script>
    <script src="js/jquery.easing.min.js"></script>
    <script src="js/wow.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.counterup.min.js"></script>
    <script src="js/jquery.countdown.min.js"></script>
    <script src="js/imagesloaded.pkgd.min.js"></script>
    <script src="js/isotope.pkgd.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/dark-mode-switch.js"></script>
    <script src="js/ion.rangeSlider.min.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/active.js"></script>
	<script src="js/jquery.inview.min.js"></script>
	<!-- date mask -->
	<script type="text/javascript" src="customjs/inputmask.js" charset="utf-8"></script>
	<script src="customjs/jquery.inputmask.date.extensions.js"></script>
    <!-- PWA -->
    <script src="js/pwa.js"></script>
	<script src="customjs/custom.js"></script>
  </body>
</html>
<script>
document.addEventListener("deviceready", onDeviceReady, false);
function onDeviceReady() {
	switch (device.platform) {
		case "Android":
			window.directory=cordova.file.externalRootDirectory;
			break;
		case "iOS":
			window.directory = cordova.file.documentsDirectory;
			break;
	}

	var permissions = cordova.plugins.permissions;
	permissions.hasPermission(permissions.WRITE_EXTERNAL_STORAGE, function( status ){
	  if ( status.hasPermission ) {
	  } else {
		permissions.requestPermission(permissions.WRITE_EXTERNAL_STORAGE, success, error);
	  }
	});

}

$(window).on('load', function() {
	// get request id id
	let searchParams = new URLSearchParams(window.location.search);
	let getid = searchParams.get('id');
	
	// general data		
	window.savedtoken = localStorage.getItem("token");
	window.lastid=0;
	
	// function to get chat
	function refresh() {
		$.ajax({
			beforeSend: function() { $('.spinner').show(); },
			complete: function(){ $('.spinner').fadeOut(); },
			type: "GET",
			url: "https://rovingcare.com/appajax/getreqchat.php?id="+getid+"&savedtoken="+savedtoken+"&lastid="+lastid,
				//data: dataString, // send token to grab data
			success: function(data) {
				var data = JSON.parse(data);
				$.each(data, function(i, field){
					if (data[i].fromroving==1) { // sent by roving
						if (data[i].file==1) { // file
							text='<div class="single-chat-item"><div class="user-avatar mt-1"><img src="img/favicon.png"></div><div class="user-message"><div class="message-content"><div class="single-message"><div class="download-file-wrap d-flex align-items-center"><div class="download-avatar bg-light"><div class="dl-icon"><i class="bi bi-file-earmark-zip-fill"></i></div><a class="download-btn" href="javascript:;"><i class="bi bi-download" onclick="download(\''+data[i].filename+'\')"></i></a></div><div class="download-file-info"><div class="file-name text-truncate">'+data[i].filename+'</div><div class="file-size">'+data[i].filesize+'</div></div></div></div></div><div class="message-time-status"><div class="sent-time">'+data[i].time+'</div></div></div></div>';
						} else { // text
							text='<div class="single-chat-item"><div class="user-avatar mt-1"><img src="img/favicon.png"></div><div class="user-message"><div class="message-content"><div class="single-message"><p>'+data[i].message+'</p></div></div><div class="message-time-status"><div class="sent-time">'+data[i].time+'</div></div></div></div>';
						}
					} else { // sent by user
						if (data[i].file==1) {
							text='<div class="single-chat-item outgoing"><div class="user-avatar mt-1"><img src="img/user-icon.png"></div><div class="user-message"><div class="message-content"><div class="single-message"><div class="download-file-wrap d-flex align-items-center"><div class="download-avatar bg-light"><div class="dl-icon"><i class="bi bi-file-earmark-zip-fill"></i></div><a class="download-btn" href="javascript:;"><i class="bi bi-download" onclick="download(\''+data[i].filename+'\')"></i></a></div><div class="download-file-info"><div class="file-name text-truncate">'+data[i].filename+'</div><div class="file-size">'+data[i].filesize+'</div></div></div></div></div><div class="message-time-status"><div class="sent-time">'+data[i].time+'</div></div></div><div>';
						} else { // text
							text='<div class="single-chat-item outgoing"><div class="user-avatar mt-1"><img src="img/user-icon.png"></div><div class="user-message"><div class="message-content"><div class="single-message"><p>'+data[i].message+'</p></div></div><div class="message-time-status"><div class="sent-time">'+data[i].time+'</div></div></div></div>';
						}
					}
					
					lastid=data[i].lastid;
					$('.chatdiv').append(text);
				});
			},
		});
	}
	
	refresh();
	setInterval(refresh, 10000);

	$.ajax({
		beforeSend: function() { $('.spinner').show(); },
		complete: function(){ $('.spinner').fadeOut(); },
		type: "GET",
		url: "https://rovingcare.com/appajax/getreq.php?id="+getid+"&savedtoken="+savedtoken,
			//data: dataString, // send token to grab data
		success: function(data) {
			var data = JSON.parse(data);
			$.each(data, function(i, field){
				$(".requestinfo").html("طلب #"+getid+" - "+data[0].servicenamear);
			});
		},
		error:function(XMLHttpRequest,textStatus,errorThrown){
			window.location.replace("requestsar.html");
		}
	});
	
	
	
	$('#backbtn').click(function(e){
		e.preventDefault();
		window.location.replace('requestar.html?id='+getid);
	});
	
	// send message
	$('.btn-submit').click(function(e){
		e.preventDefault();
		$('.alert').hide();
		textmessage=$('#textmessage').val();
		$.ajax({
			beforeSend: function() { $('.spinner-grow').show(); },
			complete: function(){ $('.spinner-grow').hide(); },
			type: "POST",
			processData: false,
			contentType: false,
			url: "https://rovingcare.com/appajax/sendchattext.php?id="+getid+"&savedtoken="+savedtoken+"&text="+textmessage,
			//data: formData, // serializes the form's elements.
			success: function(data) {
				$('#textmessage').val("");
				refresh();
			},
		});
	});
	
	$('.uploadfile').click(function() {
	   $('#newfile').click();
	});

	// send file
	$('#newfile').change(function() {
		$('.alert').hide();
		var formData = new FormData();
		formData.append('uploaded_file', $('input[type=file]')[0].files[0]); 
		
		$.ajax({
			beforeSend: function() { $('.spinner-grow').show(); },
			complete: function(){ $('.spinner-grow').hide(); },
			type: "POST",
			processData: false,
			contentType: false,
			url: "https://rovingcare.com/appajax/sendchatfile.php?id="+getid+"&savedtoken="+savedtoken,
			data: formData, // serializes the form's elements.
			success: function(data) {
				refresh();
			},
			error:function(XMLHttpRequest,textStatus,errorThrown){
			var errormsg=XMLHttpRequest.responseText;
				$('.alert').show();
				$('.alert').html(errormsg);
			}
		});
    });
});

	function download(filename) {
		alert ("بدء تنزيل الملف");
		
		randomnum=Math.floor(Math.random() * 10000);
		var fileTransfer = new FileTransfer();
		var fileURL=directory+ 'download/' +randomnum+'_'+filename;
		var uri = encodeURI("https://rovingcare.com/uploads/"+filename);
		
		// get file extension
		var ext = filename.split('.').pop();
		
		if (ext=='pdf') {
			mime='application/pdf';
		} else if (ext=='zip') {
			mime='application/zip';
		} else if (ext=='rtf') {
			mime='application/rtf';
		} else if (ext=='doc') {
			mime='application/msword';
		} else if (ext=='jpg') {
			mime='image/jpeg';
		} else if (ext=='png') {
			mime='image/png';
		} else if (ext=='gif') {
			mime='image/gif';
		} else if (ext=='mp4') {
			mime='video/mp4';
		} else if (ext=='avi') {
			mime='video/x-msvideo';
		} else if (ext=='mov') {
			mime='video/quicktime';
		} else {
			mime='null';
		}
		
		fileTransfer.download(
			uri,
			fileURL,
			function(entry) {
				alert("تم حفظ الملف");
				
				cordova.plugins.fileOpener2.open(fileURL, mime);
			},
			function(error) {
				//alert("download error target " + error.target);
			},
			false,
			{
				headers: {
					"Authorization": "Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="
				}
			}
		);
	}
</script>